repeat task.wait() until game:IsLoaded()
local Players = game:GetService('Players')
local UserInputService = game:GetService('UserInputService')
local RunService = game:GetService('RunService')
local Workspace = game:GetService('Workspace')
local ReplicatedStorage = game:GetService('ReplicatedStorage')
local VirtualUser = game:GetService('VirtualUser')
local TeleportService = game:GetService('TeleportService')
local HttpService = game:GetService('HttpService')
local Stats = game:GetService('Stats')

local player = Players.LocalPlayer
local playerGui = player:WaitForChild('PlayerGui')

-- üñ•Ô∏è T·∫†O SCREEN GUI S·ªöM
local screenGui = Instance.new('ScreenGui')
screenGui.Name = 'PetFinderMini_V2'
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = playerGui
-- üì± Responsive GUI (t·ª± co l·∫°i cho mobile)
local viewportSize = Workspace.CurrentCamera and Workspace.CurrentCamera.ViewportSize or Vector2.new(1280, 720)
local IS_SMALL_SCREEN = viewportSize.X <= 900      -- ~ mobile / tablet ƒë·ª©ng

-- K√≠ch th∆∞·ªõc khung ch√≠nh
local MAIN_WIDTH  = IS_SMALL_SCREEN and 260 or 380
local MAIN_HEIGHT = IS_SMALL_SCREEN and 340 or 420

-- Chi·ªÅu cao button to / nh·ªè
local BUTTON_HEIGHT = IS_SMALL_SCREEN and 34 or 40


-- Modules
local Packages = ReplicatedStorage:WaitForChild('Packages')
local Datas = ReplicatedStorage:WaitForChild('Datas')
local Shared = ReplicatedStorage:WaitForChild('Shared')

local Synchronizer = require(Packages:WaitForChild('Synchronizer'))
local AnimalsData = require(Datas:WaitForChild('Animals'))
local AnimalsShared = require(Shared:WaitForChild('Animals'))

---------------------------------------------------------
-- üìÅ CONFIG SYSTEM
---------------------------------------------------------
local CONFIG_FILE_NAME = "PetFinderCf.json"
local SCRIPT_VERSION = "2.6"

local DEFAULT_CONFIG = {
    -- Features
    AUTO_STEAL_ENABLED = true,
    STEAL_SPEED_ENABLED = true,
    XRAY_ENABLED = false,
    AUTO_DESYNC_ENABLED = false,
    ANTI_RAGDOLL_V2_ENABLED = false,
    
    -- ESP & Anti features
    ESP_ENABLED = false,
    ESP_PLAYERS_ENABLED = false,
    ANTI_BEE_DISCO_ENABLED = false,
    SAFE_TELEPORT = true,
    
    -- Settings
    CURRENT_MODE = 1,
    AUTO_STEAL_RADIUS = 20,
    STEAL_SPEED_VALUE = 25.5,
    LIFT_SPEED = 50,
    CURRENT_TAB = 1,
    
    -- GUI Position
    GUI_POSITION_X = 10,
    GUI_POSITION_Y = -295,
    MODE_GUI_POSITION_X = nil,
    MODE_GUI_POSITION_Y = nil,
    CONTROL_BTN_VISIBLE = true,
    MAIN_MENU_VISIBLE = true,
    MINI_GUI_VISIBLE = true,
    MINI_LEFT_GUI_VISIBLE = true,
    
    -- Version
    VERSION = SCRIPT_VERSION,
}

local CONFIG = table.clone(DEFAULT_CONFIG)

local function saveConfig()
    if not writefile then return end
    CONFIG.VERSION = SCRIPT_VERSION
    local success, err = pcall(function()
        local json = HttpService:JSONEncode(CONFIG)
        writefile(CONFIG_FILE_NAME, json)
    end)
    if success then
        print('[Config] ‚úÖ ƒê√£ l∆∞u config (v' .. SCRIPT_VERSION .. ')')
    else
        warn('[Config] ‚ùå L·ªói l∆∞u config:', err)
    end
end

local function loadConfig()
    if not readfile or not isfile then return end
    if not isfile(CONFIG_FILE_NAME) then
        print('[Config] Kh√¥ng t√¨m th·∫•y file config, t·∫°o m·ªõi...')
        saveConfig() -- l∆∞u DEFAULT_CONFIG l·∫ßn ƒë·∫ßu
        return
    end
    
    local success, result = pcall(function()
        local content = readfile(CONFIG_FILE_NAME)
        return HttpService:JSONDecode(content)
    end)
    
    if success and type(result) == 'table' then
        -- ‚ö†Ô∏è Loop theo DEFAULT_CONFIG ƒë·ªÉ ƒë·∫£m b·∫£o key m·ªõi lu√¥n c√≥ gi√° tr·ªã
        for key, defaultValue in pairs(DEFAULT_CONFIG) do
            local saved = result[key]
            if saved == nil then
                CONFIG[key] = defaultValue
            else
                CONFIG[key] = saved
            end
        end

        -- üîÅ MIGRATE KEY C≈®: n·∫øu b·∫£n c≈© c√≥ RAGDOLL th√¨ map sang ANTI_RAGDOLL_V2_ENABLED
        if result.RAGDOLL ~= nil and result.ANTI_RAGDOLL_V2_ENABLED == nil then
            CONFIG.ANTI_RAGDOLL_V2_ENABLED = result.RAGDOLL
        end

        local oldVer = result.VERSION or "1.0"
        print('[Config] ‚úÖ ƒê√£ load config (v' .. oldVer .. ' ‚Üí v' .. SCRIPT_VERSION .. ')')
    else
        warn('[Config] ‚ùå L·ªói load config, d√πng m·∫∑c ƒë·ªãnh')
    end
end

loadConfig()
-- tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa anti ragdoll, d√πng cho GUI + init
local antiRagdollEnabled = CONFIG.ANTI_RAGDOLL_V2_ENABLED

---------------------------------------------------------
-- üé® COLORS + NOTIFY
---------------------------------------------------------
local COLORS = {
    Red    = Color3.fromRGB(255, 80, 80),
    Green  = Color3.fromRGB(80, 255, 120),
    Yellow = Color3.fromRGB(255, 255, 0),
    Cyan   = Color3.fromRGB(120, 240, 255),
    Purple = Color3.fromRGB(150, 50, 220),
}

local function showNotification(msg, color)
    print('[Notify]', msg)
end

local fireproximityprompt = fireproximityprompt or function(prompt)
    if not prompt or not prompt:IsA('ProximityPrompt') then return end
    pcall(function()
        prompt:InputHoldBegin()
        task.wait(prompt.HoldDuration or 0.15)
        prompt:InputHoldEnd()
    end)
end

---------------------------------------------------------
-- üßπ X√ìA AVATAR
---------------------------------------------------------
local function clearOwnAvatar()
    local char = player.Character
    if not char then return 0 end
    
    local count = 0
    local itemTypes = {
        'Accessory', 'Hat', 'Shirt', 'Pants', 'ShirtGraphic',
        'BodyColors', 'CharacterMesh', 'Clothing'
    }
    
    for _, obj in ipairs(char:GetDescendants()) do
        for _, itemType in ipairs(itemTypes) do
            if obj:IsA(itemType) then
                pcall(function()
                    obj:Destroy()
                    count = count + 1
                end)
                break
            end
        end
    end
    
    return count
end

clearOwnAvatar()

player.CharacterAdded:Connect(function(char)
    char:WaitForChild('Humanoid')
    task.wait(0.5)
    clearOwnAvatar()
end)

---------------------------------------------------------
-- üîì UNLOCK FLOOR SYSTEM
---------------------------------------------------------
local function getClosestPlot()
    local plotsFolder = Workspace:FindFirstChild('Plots')
    if not plotsFolder then return nil end

    local char = player.Character
    local root = char and char:FindFirstChild('HumanoidRootPart')
    if not root then return nil end

    local closestPlot, closestDistance = nil, math.huge

    for _, plot in ipairs(plotsFolder:GetChildren()) do
        local sign = plot:FindFirstChild('PlotSign')
        if sign then
            local signPos = sign:GetPivot().Position
            local distance = (root.Position - signPos).Magnitude
            if distance < closestDistance then
                closestDistance = distance
                closestPlot = plot
            end
        end
    end

    return closestPlot
end

local function findPrompts(instance, found)
    found = found or {}
    for _, child in ipairs(instance:GetDescendants()) do
        if child:IsA('ProximityPrompt') then
            table.insert(found, child)
        end
    end
    return found
end

local function smartInteract(number)
    local targetPlot = getClosestPlot()
    if not targetPlot then return end

    local unlockFolder =
        targetPlot:FindFirstChild('Unlocks') or
        targetPlot:FindFirstChild('Unlock') or
        targetPlot:FindFirstChild('UnlockFolder')

    if not unlockFolder then return end

    local unlockItems = {}
    for _, item in ipairs(unlockFolder:GetChildren()) do
        local pos
        if item:IsA('Model') then
            pos = item:GetPivot().Position
        elseif item:IsA('BasePart') then
            pos = item.Position
        end

        if pos then
            table.insert(unlockItems, {
                Object = item,
                Height = pos.Y
            })
        end
    end

    if #unlockItems == 0 then return end

    table.sort(unlockItems, function(a, b)
        return a.Height < b.Height
    end)

    if number > #unlockItems then return end

    local targetFloor = unlockItems[number].Object
    local prompts = findPrompts(targetFloor)

    for _, prompt in ipairs(prompts) do
        fireproximityprompt(prompt)
    end
end

---------------------------------------------------------
-- üåÄ DESYNC V3 SYSTEM
---------------------------------------------------------
local DESYNC_FLAGS = {
    LargeReplicatorEnabled9 = true,
    GameNetDontSendRedundantNumTimes = 1,
    MaxTimestepMultiplierAcceleration = 2147483647,
    InterpolationFrameVelocityThresholdMillionth = 5,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    LargeReplicatorSerializeWrite4 = true,
    SimExplicitlyCappedTimestepMultiplier = 2147483646,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    ServerMaxBandwith = 52,
    LargeReplicatorSerializeRead3 = true,
    GameNetDontSendRedundantDeltaPositionMillionth = 1,
    PhysicsSenderMaxBandwidthBps = 20000,
    CheckPVCachedVelThresholdPercent = 10,
    NextGenReplicatorEnabledWrite4 = true,
    LargeReplicatorWrite5 = true,
    MaxMissedWorldStepsRemembered = -2147483648,
    StreamJobNOUVolumeCap = 2147483647,
    CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
    DisableDPIScale = true,
    WorldStepMax = 30,
    InterpolationFramePositionThresholdMillionth = 5,
    MaxAcceptableUpdateDelay = 1,
    TimestepArbiterOmegaThou = 1073741823,
    CheckPVCachedRotVelThresholdPercent = 10,
    StreamJobNOUVolumeLengthCap = 2147483647,
    S2PhysicsSenderRate = 15000,
    MaxTimestepMultiplierBuoyancy = 2147483647,
    SimOwnedNOUCountThresholdMillionth = 2147483647,
    ReplicationFocusNouExtentsSizeCutoffForPauseStudsPerSecHundredth = 2147483647,
    LargeReplicatorRead5 = true,
    CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
    MaxDataPacketPerSend = 2147483647,
    MaxTimestepMultiplierContstraint = 2147483647,
    DebugSendDistInSteps = -2147483648,
    GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
    AngularVelociryLimit = 360
}

local desyncEnabled = false

local function enableDesync()
    if desyncEnabled then
        showNotification('‚ö†Ô∏è Desync ƒë√£ ƒë∆∞·ª£c b·∫≠t r·ªìi!', COLORS.Yellow)
        return
    end
    
    print('[Desync V3] üîÑ ƒêang k√≠ch ho·∫°t...')
    local flagsSet = 0
    local totalFlags = 0
    
    for _ in pairs(DESYNC_FLAGS) do
        totalFlags = totalFlags + 1
    end
    
    if setfflag then
        print('[Desync V3] üîß Trying setfflag() method...')
        for flag, value in pairs(DESYNC_FLAGS) do
            local success = pcall(function()
                setfflag(flag, tostring(value))
                flagsSet = flagsSet + 1
            end)
        end
    end
    
    if flagsSet == 0 then
        print('[Desync V3] üîß Trying settings():SetFFlag() method...')
        for flag, value in pairs(DESYNC_FLAGS) do
            pcall(function()
                local s = settings()
                if s and s.GetFFlag then
                    s:SetFFlag(flag, value)
                    flagsSet = flagsSet + 1
                end
            end)
        end
    end
    
    if flagsSet > 0 then
        desyncEnabled = true
        showNotification('üåÄ Desync V3 Activated!', COLORS.Cyan)
        print('[Desync V3] ‚úÖ ƒê√£ k√≠ch ho·∫°t ' .. flagsSet .. '/' .. totalFlags .. ' flags')
    else
        warn('[Desync V3] ‚ùå Executor kh√¥ng h·ªó tr·ª£ setfflag')
        showNotification('‚ùå Executor kh√¥ng h·ªó tr·ª£ Desync!', COLORS.Red)
    end
end

---------------------------------------------------------
-- üîÑ INSTANT CLONER
---------------------------------------------------------
local isCloning = false

local function instantCloner()
    if isCloning then
        showNotification('‚ö†Ô∏è Cloner ƒëang ch·∫°y...', COLORS.Yellow)
        return
    end
    
    isCloning = true
    print('[Cloner V2.2] üöÄ Activating Quantum Cloner...')
    
    local success, err = pcall(function()
        local character = player.Character
        if not character then error("Character not found") end
        
        local humanoid = character:FindFirstChild("Humanoid")
        if not humanoid then error("Humanoid not found") end
        
        for _, tool in ipairs(character:GetChildren()) do
            if tool:IsA("Tool") then
                humanoid:UnequipTools()
                task.wait(0.1)
                break
            end
        end
        
        local backpack = player.Backpack
        local cloner = backpack:FindFirstChild("Quantum Cloner")
        if not cloner then 
            error("Quantum Cloner not found in inventory!") 
        end
        
        print('[Cloner V2.2] ‚úÖ Found Quantum Cloner, equipping...')
        
        humanoid:EquipTool(cloner)
        task.wait(0.1)
        
        local useRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/UseItem")
        useRemote:FireServer()
        task.wait(0.1)
        
        local clonerRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/QuantumCloner/OnTeleport")
        clonerRemote:FireServer()
        
        print('[Cloner V2.2] ‚úÖ Quantum Cloner activated!')
        showNotification('üöÄ Instant Cloner Activated!', COLORS.Cyan)
    end)
    
    if not success then
        warn('[Cloner V2.2] ‚ùå Error:', err)
        showNotification('‚ùå Cloner Failed: ' .. tostring(err), COLORS.Red)
    end
    
    task.wait(1)
    isCloning = false
end

local function kickSelf()
    player:Kick('üëã B·∫°n ƒë√£ t·ª± kick')
end

---------------------------------------------------------
-- üéØ AUTO-STEAL SYSTEM (FIX THEO BRAINROT)
---------------------------------------------------------
local allAnimalsCache = {}
local InternalStealCache = {}
local PromptMemoryCache = {}
local AUTO_STEAL_ENABLED = CONFIG.AUTO_STEAL_ENABLED
local AUTO_STEAL_PROX_RADIUS = CONFIG.AUTO_STEAL_RADIUS
local LastTargetUID = nil

---------------------------------------------------------
-- üëÅÔ∏è ESP SYSTEMS
---------------------------------------------------------
local ESP_INSTANCES = {}
local ESP_BEST_UID = nil
local PLAYER_ESP = {}

local function formatNumber(num)
    if num >= 1e12 then return string.format("%.2fT", num / 1e12)
    elseif num >= 1e9 then return string.format("%.2fB", num / 1e9)
    elseif num >= 1e6 then return string.format("%.2fM", num / 1e6)
    elseif num >= 1e3 then return string.format("%.2fK", num / 1e3)
    else return tostring(num)
    end
end

local function isMyBaseAnimal(plotName)
    if not plotName then return false end
    local plots = Workspace:FindFirstChild('Plots')
    if not plots then return false end
    local plotObj = plots:FindFirstChild(plotName)
    if not plotObj then return false end
    
    local success, channel = pcall(function()
        return Synchronizer:Get(plotObj.Name)
    end)
    
    if success and channel then
        local ownerSuccess, owner = pcall(function()
            return channel:Get('Owner')
        end)
        
        if ownerSuccess and owner then
            if typeof(owner) == 'Instance' and owner:IsA('Player') then
                return owner.UserId == player.UserId
            elseif typeof(owner) == 'table' and owner.UserId then
                return owner.UserId == player.UserId
            end
        end
    end
    
    local sign = plotObj:FindFirstChild('PlotSign')
    if sign then
        local yourBase = sign:FindFirstChild('YourBase')
        if yourBase and yourBase:IsA('BillboardGui') then
            return yourBase.Enabled == true
        end
    end
    
    return false
end

-- FIX: GET ALL ANIMALS THEO BRAINROT
local function getAllAnimals()
    local animals = {}
    local plots = Workspace:FindFirstChild('Plots')
    if not plots then return animals end
    
    for _, plot in ipairs(plots:GetChildren()) do
        if isMyBaseAnimal(plot.Name) then continue end
        
        local success1, channel = pcall(function()
            return Synchronizer:Get(plot.Name)
        end)
        if not success1 or not channel then continue end
        
        local success2, animalList = pcall(function()
            return channel:Get('AnimalList')
        end)
        if not success2 or not animalList then continue end
        
        for slot, animalData in pairs(animalList) do
            if type(animalData) == 'table' and animalData.Index then
                local genValue = 0
                
                pcall(function()
                    genValue = AnimalsShared:GetGeneration(
                        animalData.Index,
                        animalData.Mutation,
                        animalData.Traits,
                        nil
                    ) or 0
                end)
                
                local animalInfo
                pcall(function()
                    animalInfo =
                        AnimalsData[animalData.Index] or
                        AnimalsData[tonumber(animalData.Index)] or
                        AnimalsData[tostring(animalData.Index)]
                end)
                
                local name = animalData.Name or animalData.name
                if not name and animalInfo then
                    name = animalInfo.DisplayName or animalInfo.Name or animalInfo.PetName
                end
                if not name then
                    name = "ID " .. tostring(animalData.Index)
                end
                
                table.insert(animals, {
                    plot = plot.Name,
                    slot = tostring(slot),
                    data = animalData,
                    genValue = genValue or 0,
                    name = name,
                    uid = plot.Name .. "_" .. tostring(slot)
                })
            end
        end
    end
    
    table.sort(animals, function(a, b)
        local aVal = tonumber(a.genValue) or 0
        local bVal = tonumber(b.genValue) or 0
        return aVal > bVal
    end)
    
    return animals
end

local currentMode = CONFIG.CURRENT_MODE

-- FIX: GET ANIMAL POSITION THEO BRAINROT
local function getAnimalPosition(plot, slot)
    local plots = Workspace:FindFirstChild('Plots')
    if not plots then return nil end
    local plotObj = plots:FindFirstChild(plot)
    if not plotObj then return nil end
    
    local podiums = plotObj:FindFirstChild('AnimalPodiums')
    if not podiums then return nil end
    local podium = podiums:FindFirstChild(slot)
    if not podium then return nil end
    
    if podium:IsA("Model") then
        return podium:GetPivot().Position
    elseif podium:IsA("BasePart") then
        return podium.Position
    end
    
    return nil
end

-- FIX: FIND PROXIMITY PROMPT THEO BRAINROT
local function findProximityPromptForAnimal(plot, slot)
    local uid = plot .. '_' .. slot
    local cachedPrompt = PromptMemoryCache[uid]
    if cachedPrompt and cachedPrompt.Parent then
        return cachedPrompt
    end
    
    local plots = Workspace:FindFirstChild('Plots')
    if not plots then return nil end
    local plotObj = plots:FindFirstChild(plot)
    if not plotObj then return nil end
    
    local podiums = plotObj:FindFirstChild('AnimalPodiums')
    if not podiums then return nil end
    local podium = podiums:FindFirstChild(slot)
    if not podium then return nil end
    
    -- Search all descendants for ProximityPrompt
    for _, descendant in ipairs(podium:GetDescendants()) do
        if descendant:IsA('ProximityPrompt') then
            PromptMemoryCache[uid] = descendant
            return descendant
        end
    end
    
    return nil
end

-- FIX: BUILD STEAL CALLBACKS THEO BRAINROT (MOBILE SAFE)
local function buildStealCallbacks(prompt)
    if InternalStealCache[prompt] then return end

    local data = {
        holdCallbacks = {},
        triggerCallbacks = {},
        ready = true,
    }

    -- üîê N·∫øu executor kh√¥ng c√≥ getconnections (ƒëa s·ªë mobile) th√¨ th√¥i, d√πng fallback fireproximityprompt
    if not getconnections then
        return
    end

    local ok1, conns1 = pcall(function()
        return getconnections(prompt.PromptButtonHoldBegan)
    end)
    if ok1 and type(conns1) == "table" then
        for _, conn in ipairs(conns1) do
            if type(conn.Function) == "function" then
                table.insert(data.holdCallbacks, conn.Function)
            end
        end
    end

    local ok2, conns2 = pcall(function()
        return getconnections(prompt.Triggered)
    end)
    if ok2 and type(conns2) == "table" then
        for _, conn in ipairs(conns2) do
            if type(conn.Function) == "function" then
                table.insert(data.triggerCallbacks, conn.Function)
            end
        end
    end

    if (#data.holdCallbacks > 0) or (#data.triggerCallbacks > 0) then
        InternalStealCache[prompt] = data
    end
end

-- FIX: EXECUTE INTERNAL STEAL ASYNC THEO BRAINROT
local function executeInternalStealAsync(prompt)
    local data = InternalStealCache[prompt]
    if not data or not data.ready then return false end
    
    data.ready = false
    
    task.spawn(function()
        -- Execute hold callbacks
        if #data.holdCallbacks > 0 then
            for _, fn in ipairs(data.holdCallbacks) do
                task.spawn(fn)
            end
        end
        
        -- Wait for hold duration
        local holdDuration = prompt.HoldDuration or 0.5
        task.wait(holdDuration + 0.1)
        
        -- Execute trigger callbacks
        if #data.triggerCallbacks > 0 then
            for _, fn in ipairs(data.triggerCallbacks) do
                task.spawn(fn)
            end
        end
        
        task.wait(0.3)
        data.ready = true
    end)
    
    return true
end

-- FIX: ATTEMPT STEAL THEO BRAINROT
local function attemptSteal(prompt, uid)
    if not prompt or not prompt.Parent then return false end
    
    buildStealCallbacks(prompt)
    
    if not InternalStealCache[prompt] then
        -- Fallback to fireproximityprompt
        return fireproximityprompt(prompt)
    end
    
    return executeInternalStealAsync(prompt)
end

local stealConnection = nil

-- FIX: AUTO STEAL LOOP THEO BRAINROT
local function autoStealLoop()
    if stealConnection then stealConnection:Disconnect() end
    
    stealConnection = RunService.Heartbeat:Connect(function()
        if not AUTO_STEAL_ENABLED then return end
        
        local char = player.Character
        if not char then return end
        local hrp = char:FindFirstChild('HumanoidRootPart')
        if not hrp then return end
        
        -- Get all animals and find the best one
        local animals = getAllAnimals()
        if #animals == 0 then return end
        
        local bestAnimal = animals[1]  -- Highest gen value
        local uid = bestAnimal.uid
        
        -- Check if we should target this animal
        if LastTargetUID == uid then
            -- Already targeting, check cooldown
            task.wait(0.1)
            return
        end
        
        local animalPos = getAnimalPosition(bestAnimal.plot, bestAnimal.slot)
        if not animalPos then return end
        
        local distance = (hrp.Position - animalPos).Magnitude
        if distance > AUTO_STEAL_PROX_RADIUS then return end
        
        -- Find and attempt steal
        local prompt = findProximityPromptForAnimal(bestAnimal.plot, bestAnimal.slot)
        if prompt then
            local success = attemptSteal(prompt, uid)
            if success then
                LastTargetUID = uid
                print('[Auto Steal] üéØ Stealing:', bestAnimal.name, '($' .. formatNumber(bestAnimal.genValue) .. '/s)')
                
                -- Clear target after delay
                task.delay(2, function()
                    if LastTargetUID == uid then
                        LastTargetUID = nil
                    end
                end)
            end
        end
    end)
end

---------------------------------------------------------
-- üëÅÔ∏è ANIMAL ESP (FIX THEO BRAINROT)
---------------------------------------------------------
local function clearESPForUID(uid)
    local rec = ESP_INSTANCES[uid]
    if not rec then return end
    if rec.highlight then pcall(function() rec.highlight:Destroy() end) end
    if rec.billboard then pcall(function() rec.billboard:Destroy() end) end
    ESP_INSTANCES[uid] = nil
end

local function clearAllESP()
    for uid in pairs(ESP_INSTANCES) do
        clearESPForUID(uid)
    end
    ESP_BEST_UID = nil
end

-- FIX: GET PODIUM WORLD PART THEO BRAINROT
local function getPodiumWorldPart(animal)
    if not animal.plot or not animal.slot then return nil end
    
    local plots = Workspace:FindFirstChild('Plots')
    if not plots then return nil end
    
    local plot = plots:FindFirstChild(animal.plot)
    if not plot then return nil end
    
    local podiums = plot:FindFirstChild("AnimalPodiums")
    if not podiums then return nil end
    
    local podium = podiums:FindFirstChild(animal.slot)
    if not podium then return nil end
    
    -- Return the model or first BasePart
    if podium:IsA("Model") then
        local primary = podium.PrimaryPart
        if primary then return primary end
        
        for _, child in ipairs(podium:GetDescendants()) do
            if child:IsA("BasePart") and child.Name ~= "PromptAttachment" then
                return child
            end
        end
    elseif podium:IsA("BasePart") then
        return podium
    end
    
    return nil
end

-- FIX: REFRESH ALL ESP THEO BRAINROT
local function refreshAllESP()
    if not CONFIG.ESP_ENABLED then
        clearAllESP()
        return
    end
    
    local activeUIDs = {}
    local threshold = 10000000  -- 10M
    
    for _, animalData in ipairs(allAnimalsCache) do
        if isMyBaseAnimal(animalData.plot) then
            -- skip own base
        else
            local gen = tonumber(animalData.genValue) or 0
            local uid = animalData.uid
            
            if gen >= threshold then
                activeUIDs[uid] = true
                
                local rec = ESP_INSTANCES[uid]
                local targetPart = getPodiumWorldPart(animalData)
                
                if not targetPart then
                    if rec then clearESPForUID(uid) end
                else
                    if not rec or rec.part ~= targetPart then
                        if rec then clearESPForUID(uid) end
                        
                        rec = { part = targetPart }
                        
                        -- Create Highlight (attach to ScreenGui)
                        local highlight = Instance.new("Highlight")
                        highlight.Adornee = targetPart
                        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                        highlight.FillTransparency = 0.6
                        highlight.FillColor = Color3.fromRGB(220, 120, 255)
                        highlight.OutlineTransparency = 0
                        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
                        highlight.Parent = screenGui
                        rec.highlight = highlight
                        
                        -- Create BillboardGui (attach to ScreenGui)
                        local bb = Instance.new("BillboardGui")
                        bb.Name = "AnimalESP_" .. uid
                        bb.Adornee = targetPart
                        bb.AlwaysOnTop = true
                        bb.Size = UDim2.new(0, 180, 0, 65)
                        bb.StudsOffset = Vector3.new(0, 4, 0)
                        bb.Parent = screenGui
                        rec.billboard = bb
                        
                        local bgFrame = Instance.new("Frame")
                        bgFrame.Size = UDim2.new(1, 0, 1, 0)
                        bgFrame.BackgroundColor3 = Color3.fromRGB(100, 50, 150)
                        bgFrame.BackgroundTransparency = 0.7
                        bgFrame.BorderSizePixel = 0
                        bgFrame.Parent = bb
                        
                        local corner = Instance.new("UICorner")
                        corner.CornerRadius = UDim.new(0, 10)
                        corner.Parent = bgFrame
                        
                        local nameLabel = Instance.new("TextLabel")
                        nameLabel.Size = UDim2.new(1, -10, 0.5, 0)
                        nameLabel.Position = UDim2.new(0, 5, 0, 5)
                        nameLabel.BackgroundTransparency = 1
                        nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                        nameLabel.TextScaled = true
                        nameLabel.Font = Enum.Font.GothamBold
                        nameLabel.TextStrokeTransparency = 0
                        nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                        nameLabel.Parent = bgFrame
                        
                        local genLabel = Instance.new("TextLabel")
                        genLabel.Size = UDim2.new(1, -10, 0.5, -5)
                        genLabel.Position = UDim2.new(0, 5, 0.5, 0)
                        genLabel.BackgroundTransparency = 1
                        genLabel.TextColor3 = Color3.fromRGB(255, 255, 120)
                        genLabel.TextScaled = true
                        genLabel.Font = Enum.Font.GothamBold
                        genLabel.TextStrokeTransparency = 0
                        genLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
                        genLabel.Parent = bgFrame
                        
                        rec.labelName = nameLabel
                        rec.labelGen = genLabel
                        
                        ESP_INSTANCES[uid] = rec
                    end
                    
                    -- Update text
                    if rec.labelName then
                        rec.labelName.Text = animalData.name
                    end
                    if rec.labelGen then
                        rec.labelGen.Text = "$" .. formatNumber(gen) .. "/s"
                    end
                end
            end
        end
    end
    
    -- Clear inactive UIDs
    for uid in pairs(ESP_INSTANCES) do
        if not activeUIDs[uid] then
            clearESPForUID(uid)
        end
    end
end

---------------------------------------------------------
-- üë§ PLAYER ESP SYSTEM
---------------------------------------------------------
local function clearPlayerESP(plr)
    local rec = PLAYER_ESP[plr]
    if not rec then return end
    
    if rec.highlight then pcall(function() rec.highlight:Destroy() end) end
    if rec.billboard then pcall(function() rec.billboard:Destroy() end) end
    if rec.espRoot then pcall(function() rec.espRoot:Destroy() end) end
    
    PLAYER_ESP[plr] = nil
end

local function clearAllPlayerESP()
    for plr in pairs(PLAYER_ESP) do
        clearPlayerESP(plr)
    end
end

local function createPlayerESP(plr)
    local char = plr.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("UpperTorso")
    if not hrp then return end
    
    local rec = {}
    
    local espRoot = Instance.new("Part")
    espRoot.Name = "PlayerESPRoot_" .. plr.Name
    espRoot.Anchored = true
    espRoot.CanCollide = false
    espRoot.Transparency = 1
    espRoot.Size = Vector3.new(2, 4, 2)
    espRoot.CFrame = hrp.CFrame
    espRoot.Parent = Workspace
    rec.espRoot = espRoot
    
    local highlight = Instance.new("Highlight")
    highlight.Adornee = espRoot
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.FillTransparency = 1
    highlight.OutlineTransparency = 0
    highlight.OutlineColor = Color3.fromRGB(120, 240, 255)
    highlight.Parent = screenGui
    rec.highlight = highlight
    
    local bb = Instance.new("BillboardGui")
    bb.Size = UDim2.new(0, 150, 0, 30)
    bb.Adornee = hrp
    bb.AlwaysOnTop = true
    bb.StudsOffset = Vector3.new(0, 3.2, 0)
    bb.Parent = screenGui
    rec.billboard = bb
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 1, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(120, 240, 255)
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextStrokeTransparency = 0.3
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.Text = plr.Name
    nameLabel.Parent = bb
    rec.nameLabel = nameLabel
    
    PLAYER_ESP[plr] = rec
end

local function refreshPlayerESP()
    if not CONFIG.ESP_PLAYERS_ENABLED then
        clearAllPlayerESP()
        return
    end
    
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= player then
            if not PLAYER_ESP[plr] then
                createPlayerESP(plr)
            end
        end
    end
    
    local myChar = player.Character
    local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
    
    for plr, rec in pairs(PLAYER_ESP) do
        local char = plr.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        
        if not char or not hrp or not myHRP then
            clearPlayerESP(plr)
        else
            if rec.espRoot then
                rec.espRoot.CFrame = hrp.CFrame
            end
            
            local dist = (myHRP.Position - hrp.Position).Magnitude
            local distInt = math.floor(dist + 0.5)
            
            if rec.nameLabel then
                rec.nameLabel.Text = string.format("%s [%dm]", plr.Name, distInt)
            end
        end
    end
end

---------------------------------------------------------
-- üîÅ ESP AUTO-REFRESH LOOP
---------------------------------------------------------
task.spawn(function()
    while true do
        task.wait(0.5)
        if CONFIG.ESP_ENABLED then
            allAnimalsCache = getAllAnimals()
            refreshAllESP()
        end
        if CONFIG.ESP_PLAYERS_ENABLED then
            refreshPlayerESP()
        end
    end
end)

---------------------------------------------------------
-- üêù ANTI-BEE & ANTI-DISCO (REWRITE V2 - LOCK CAMERA)
---------------------------------------------------------
local Lighting = game:GetService("Lighting")

local antiBeeDiscoRunning = false
local antiBeeDiscoConnections = {}
local controlsProtected = false
local originalMoveFunction = nil
local cachedControls = nil

-- b·∫£o v·ªá camera
local cameraProtected = false
local originalCameraSettings = nil

local BAD_LIGHTING_NAMES = {
    Blue = true,
    DiscoEffect = true,
    BeeBlur = true,
    ColorCorrection = true,
}

local function disconnectAntiBeeDisco()
    for _, conn in ipairs(antiBeeDiscoConnections) do
        if typeof(conn) == "RBXScriptConnection" then
            pcall(function() conn:Disconnect() end)
        end
    end
    antiBeeDiscoConnections = {}
end

local function antiBeeDiscoNuke(obj)
    if not obj or not obj.Parent then return end
    if BAD_LIGHTING_NAMES[obj.Name] then
        pcall(function()
            obj:Destroy()
        end)
    end
end

local function blockBuzzingSound()
    pcall(function()
        local PlayerScripts = player:FindFirstChild("PlayerScripts")
        if not PlayerScripts then return end

        local beeScript = PlayerScripts:FindFirstChild("Bee", true)
        if beeScript then
            local buzzing = beeScript:FindFirstChild("Buzzing")
            if buzzing and buzzing:IsA("Sound") then
                buzzing:Stop()
                buzzing.Volume = 0
            end
        end
    end)
end

local function getControls()
    if cachedControls then return cachedControls end

    local PlayerScripts = player:FindFirstChild("PlayerScripts")
    if not PlayerScripts then return nil end

    local okModule, playerModule = pcall(function()
        return require(PlayerScripts:WaitForChild("PlayerModule"))
    end)
    if not okModule or not playerModule then return nil end

    local okControls, controls = pcall(function()
        return playerModule:GetControls()
    end)
    if not okControls or not controls then return nil end

    cachedControls = controls
    return cachedControls
end

local function protectControls()
    if controlsProtected then return end

    local controls = getControls()
    if not controls or not controls.moveFunction then return end

    controlsProtected = true
    originalMoveFunction = controls.moveFunction

    local function protectedMove(self, moveVector, relativeToCamera)
        -- lu√¥n ∆∞u ti√™n move g·ªëc, kh√¥ng cho script kh√°c ƒë·ªïi sang h√†m kh√≥a ph√≠m
        if originalMoveFunction then
            return originalMoveFunction(self, moveVector, relativeToCamera)
        end
    end

    controls.moveFunction = protectedMove

    local conn = RunService.Heartbeat:Connect(function()
        if not antiBeeDiscoRunning then return end
        local c = getControls()
        if c and c.moveFunction ~= protectedMove then
            c.moveFunction = protectedMove
        end
    end)
    table.insert(antiBeeDiscoConnections, conn)
end

local function restoreControls()
    if not controlsProtected then return end
    controlsProtected = false

    local controls = getControls()
    if controls and originalMoveFunction then
        pcall(function()
            controls.moveFunction = originalMoveFunction
        end)
    end

    originalMoveFunction = nil
end

-- üîí CAMERA PROTECT
local function enforceCamera()
    local cam = Workspace.CurrentCamera
    if not cam then return end

    if not originalCameraSettings then
        originalCameraSettings = {
            CameraType = cam.CameraType,
            FieldOfView = cam.FieldOfView,
        }
    end

    -- kh√¥ng cho set Scriptable / Track / Attach
    if cam.CameraType ~= Enum.CameraType.Custom
    and cam.CameraType ~= Enum.CameraType.Follow then
        cam.CameraType = Enum.CameraType.Custom
    end

    local char = player.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    if hum and cam.CameraSubject ~= hum then
        cam.CameraSubject = hum
    end

    -- h·∫°n FOV l·∫°i cho ƒë·ª° zoom/gi·∫≠t
    if cam.FieldOfView < 60 or cam.FieldOfView > 80 then
        cam.FieldOfView = 70
    end
end

local function protectCamera()
    if cameraProtected then return end
    cameraProtected = true

    -- Heartbeat √©p camera v·ªÅ tr·∫°ng th√°i an to√†n
    local conn1 = RunService.RenderStepped:Connect(function()
        if not antiBeeDiscoRunning then return end
        enforceCamera()
    end)
    table.insert(antiBeeDiscoConnections, conn1)

    -- n·∫øu game ƒë·ªïi CurrentCamera th√¨ c≈©ng √©p l·∫°i
    local conn2 = Workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
        if not antiBeeDiscoRunning then return end
        enforceCamera()
    end)
    table.insert(antiBeeDiscoConnections, conn2)
end

local function restoreCamera()
    cameraProtected = false

    local cam = Workspace.CurrentCamera
    if cam and originalCameraSettings then
        pcall(function()
            cam.CameraType = originalCameraSettings.CameraType
            cam.FieldOfView = originalCameraSettings.FieldOfView
        end)
    end

    originalCameraSettings = nil
end

local function startAntiBee()
    if antiBeeDiscoRunning then return end
    antiBeeDiscoRunning = true

    print('[Anti-Bee & Disco] üêù Enabled')
    showNotification('üêù Anti-Bee & Anti-Disco Enabled', COLORS.Green)

    -- clear t·∫•t c·∫£ effect x·∫•u ƒëang t·ªìn t·∫°i
    for _, inst in ipairs(Lighting:GetDescendants()) do
        antiBeeDiscoNuke(inst)
    end

    -- x√≥a m·ªçi effect m·ªõi spawn sau n√†y
    local conn1 = Lighting.DescendantAdded:Connect(function(obj)
        if not antiBeeDiscoRunning then return end
        antiBeeDiscoNuke(obj)
    end)
    table.insert(antiBeeDiscoConnections, conn1)

    -- b·∫£o v·ªá Controls kh√¥ng b·ªã script bee/disco gi√†nh m·∫•t
    protectControls()

    -- b·∫£o v·ªá camera kh√¥ng b·ªã script ch·ªânh lung tung
    protectCamera()

    -- spam block ti·∫øng ong m·ªói frame
    local conn2 = RunService.Heartbeat:Connect(function()
        if not antiBeeDiscoRunning then return end
        blockBuzzingSound()
    end)
    table.insert(antiBeeDiscoConnections, conn2)
end

local function stopAntiBee()
    if not antiBeeDiscoRunning then return end
    antiBeeDiscoRunning = false

    restoreControls()
    restoreCamera()
    disconnectAntiBeeDisco()

    print('[Anti-Bee & Disco] üêù Disabled')
    showNotification('üêù Anti-Bee & Anti-Disco Disabled', COLORS.Red)
end




---------------------------------------------------------
-- üöÄ TP HIGHEST (FIX THEO BRAINROT)
---------------------------------------------------------

-- Helper functions for safe teleport
local function getSideBounds(sideFolder)
    if not sideFolder then return nil end
    
    local minX, minY, minZ = math.huge, math.huge, math.huge
    local maxX, maxY, maxZ = -math.huge, -math.huge, -math.huge
    local found = false
    
    local function scan(obj)
        for _, child in ipairs(obj:GetChildren()) do
            if child:IsA("BasePart") then
                found = true
                local p = child.Position
                minX = math.min(minX, p.X)
                minY = math.min(minY, p.Y)
                minZ = math.min(minZ, p.Z)
                maxX = math.max(maxX, p.X)
                maxY = math.max(maxY, p.Y)
                maxZ = math.max(maxZ, p.Z)
            else
                scan(child)
            end
        end
    end
    
    scan(sideFolder)
    if not found then return nil end
    
    local center = Vector3.new((minX + maxX) * 0.5, (minY + maxY) * 0.5, (minZ + maxZ) * 0.5)
    local halfSize = Vector3.new((maxX - minX) * 0.5, (maxY - minY) * 0.5, (maxZ - minZ) * 0.5)
    
    return {
        center = center,
        halfSize = halfSize,
    }
end
local function getSafeOutsideDecorPos(plot, targetPos, fromPos)
    local decorations = plot:FindFirstChild("Decorations")
    if not decorations then return targetPos end
    
    local side3Folder = decorations:FindFirstChild("Side 3")
    if not side3Folder then return targetPos end
    
    local info = getSideBounds(side3Folder)
    if not info then return targetPos end
    
    local center = info.center
    local halfSize = info.halfSize
    local MARGIN = 4
    
    local localTarget = targetPos - center
    local insideX = math.abs(localTarget.X) <= halfSize.X
    local insideZ = math.abs(localTarget.Z) <= halfSize.Z
    
    if not (insideX and insideZ) then
        return targetPos
    end
    
    local src = fromPos and (fromPos - center) or localTarget
    local dir = Vector3.new(src.X, 0, src.Z)
    
    if dir.Magnitude < 1e-3 then
        dir = Vector3.new(0, 0, 1)
    end
    
    local dirUnit = dir.Unit
    
    local tx, tz = math.huge, math.huge
    
    if dirUnit.X ~= 0 then
        local boundX = (dirUnit.X > 0) and halfSize.X or -halfSize.X
        tx = boundX / dirUnit.X
    end
    
    if dirUnit.Z ~= 0 then
        local boundZ = (dirUnit.Z > 0) and halfSize.Z or -halfSize.Z
        tz = boundZ / dirUnit.Z
    end
    
    local tHit = math.min(tx, tz)
    if tHit == math.huge then return targetPos end
    
    local boundaryLocal = dirUnit * (tHit + MARGIN)
    local worldPos = center + boundaryLocal
    
    return Vector3.new(worldPos.X, targetPos.Y, worldPos.Z)
end

-- FIX: GET SMART CARPET POSITION THEO BRAINROT
local function getSmartCarpetPosition(carpetPart, fromPos)
    if not carpetPart or not fromPos then return nil end
    
    local cf = carpetPart.CFrame
    local size = carpetPart.Size
    local halfX = size.X / 2
    local halfZ = size.Z / 2
    
    local localPos = cf:PointToObjectSpace(fromPos)
    
    local clampedX = math.clamp(localPos.X, -halfX, halfX)
    local clampedZ = math.clamp(localPos.Z, -halfZ, halfZ)
    
    if math.abs(localPos.X) < halfX and math.abs(localPos.Z) < halfZ then
        local distToEdges = {
            north = halfZ - localPos.Z,
            south = halfZ + localPos.Z,
            east = halfX - localPos.X,
            west = halfX + localPos.X
        }
        
        local minDist = math.huge
        local nearestEdge = "north"
        
        for edge, dist in pairs(distToEdges) do
            if dist < minDist then
                minDist = dist
                nearestEdge = edge
            end
        end
        
        if nearestEdge == "north" then
            clampedZ = halfZ
        elseif nearestEdge == "south" then
            clampedZ = -halfZ
        elseif nearestEdge == "east" then
            clampedX = halfX
        else
            clampedX = -halfX
        end
    end
    
    local nearestPoint = cf:PointToWorldSpace(Vector3.new(clampedX, 0, clampedZ))
    
    local rayOrigin = nearestPoint + Vector3.new(0, 50, 0)
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = { Workspace.Map }
    rayParams.FilterType = Enum.RaycastFilterType.Whitelist
    
    local result = Workspace:Raycast(rayOrigin, Vector3.new(0, -100, 0), rayParams)
    local finalY = result and result.Position.Y or fromPos.Y
    
    return Vector3.new(nearestPoint.X, finalY, nearestPoint.Z)
end

-- FIX: TP NEAR PLOT IF FAR
local function tpNearPlotIfFar(animalData)
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild('HumanoidRootPart')
    if not hrp or not animalData or not animalData.plot then return end

    local plots = Workspace:FindFirstChild('Plots')
    if not plots then return end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then return end

    local plotPos = plot:GetPivot().Position

    if (hrp.Position - plotPos).Magnitude <= 100 then
        return
    end

    local decorations = plot:FindFirstChild("Decorations")
    local side3 = decorations and decorations:FindFirstChild("Side 3") or nil

    local info = side3 and getSideBounds(side3) or nil
    local center = info and info.center or plotPos

    local dir = (hrp.Position - center).Unit

    local distanceFromPlot = 70
    local y = center.Y + 4

    local finalPos = Vector3.new(
        center.X + dir.X * distanceFromPlot,
        y,
        center.Z + dir.Z * distanceFromPlot
    )

    hrp.CFrame = CFrame.new(finalPos, center)
end

-- FIX: TELEPORT TO ANIMAL THEO BRAINROT
local function teleportToAnimal(animalData)
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        showNotification("‚ö†Ô∏è Character not found!", COLORS.Yellow)
        return false
    end
    
    local humanoid = character:FindFirstChild("Humanoid")
    local hrp = character.HumanoidRootPart
    if not humanoid or not hrp then return false end
    
    -- EQUIP CARPET
    local carpet = player.Backpack:FindFirstChild("Flying Carpet")
    if carpet then
        humanoid:EquipTool(carpet)
        task.wait(0.2)
        print('[TP Highest] ‚úÖ Equipped Flying Carpet')
    end
    
    local plots = Workspace:FindFirstChild('Plots')
    if not plots then
        showNotification("‚ö†Ô∏è Plots not found!", COLORS.Yellow)
        return false
    end
    
    local plot = plots:FindFirstChild(animalData.plot)
    if not plot then
        showNotification("‚ö†Ô∏è Plot not found!", COLORS.Yellow)
        return false
    end
    
    -- GET TARGET POSITION
    local targetPos = getAnimalPosition(animalData.plot, animalData.slot)
    if not targetPos then
        -- Fallback to plot spawn
        local spawnPart = plot:FindFirstChild("Spawn")
        if spawnPart and spawnPart:IsA("BasePart") then
            targetPos = Vector3.new(spawnPart.Position.X, 10, spawnPart.Position.Z)
        else
            targetPos = plot:GetPivot().Position + Vector3.new(0, 10, 0)
        end
    end
    
    local animalY = targetPos.Y
    local highAnimal = animalY > 10
    local currentPos = hrp.Position
    
    -- SAFE TELEPORT WITH CARPET
    if CONFIG.SAFE_TELEPORT then
        local mapFolder = Workspace:FindFirstChild("Map")
        if mapFolder then
            local carpetPart = mapFolder:FindFirstChild("Carpet")
            if carpetPart and carpetPart:IsA("BasePart") then
                local carpetPos = getSmartCarpetPosition(carpetPart, currentPos)
                if carpetPos then
                    print('[TP Highest] üöÅ Using Safe Teleport via Carpet')
                    
                    -- Jump up
                    local state = humanoid:GetState()
                    if state ~= Enum.HumanoidStateType.Jumping and state ~= Enum.HumanoidStateType.Freefall then
                        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                        task.wait(0.05)
                    end
                    
                    -- Apply upward velocity
                    hrp.Velocity = Vector3.new(hrp.Velocity.X, 200, hrp.Velocity.Z)
                    task.wait(0.15)
                    
                    -- TP to carpet
                    hrp.CFrame = CFrame.new(carpetPos.X, hrp.Position.Y, carpetPos.Z)
                    task.wait(0.4)
                    
                    -- TP near plot if far
                    tpNearPlotIfFar(animalData)
                    task.wait(0.4)
                else
                    print('[TP Highest] ‚ö†Ô∏è Could not calculate carpet position')
                end
            else
                print('[TP Highest] ‚ö†Ô∏è Carpet part not found')
            end
        end
    else
        -- Direct teleport
        if highAnimal then
            local state = humanoid:GetState()
            if state ~= Enum.HumanoidStateType.Jumping and state ~= Enum.HumanoidStateType.Freefall then
                humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                task.wait(0.05)
            end
            
            hrp.Velocity = Vector3.new(hrp.Velocity.X, 200, hrp.Velocity.Z)
            task.wait(0.2)
        end
    end
    
    -- CALCULATE FINAL POSITION
    local finalPos
    if highAnimal then
        finalPos = Vector3.new(targetPos.X, math.max(targetPos.Y, 20), targetPos.Z)
    else
        finalPos = targetPos
    end
    
    -- Apply decoration safety
    finalPos = getSafeOutsideDecorPos(plot, finalPos, currentPos)
    
    -- FINAL TELEPORT
    hrp.CFrame = CFrame.new(finalPos)
    
    showNotification(string.format("üöÄ TP: %s ($%s/s)", animalData.name, formatNumber(animalData.genValue)), COLORS.Cyan)
    print('[TP Highest] ‚úÖ Teleported to:', animalData.name, '| Gen: $' .. formatNumber(animalData.genValue) .. '/s')
    return true
end

-- FIX: TELEPORT TO HIGHEST
local function teleportToHighest()
    allAnimalsCache = getAllAnimals()
    
    if #allAnimalsCache == 0 then
        showNotification("‚ùå No animals found!", COLORS.Red)
        return
    end
    
    local bestAnimal = allAnimalsCache[1]
    print('[TP Highest] üéØ Target:', bestAnimal.name, '($' .. formatNumber(bestAnimal.genValue) .. '/s)')
    
    teleportToAnimal(bestAnimal)
end

---------------------------------------------------------
-- üõ°Ô∏è ANTI-RAGDOLL (PORT T·ª™ SCRIPT 6000 D√íNG ‚Äì B·∫¢N MOVEABLE)
---------------------------------------------------------
-- Thay **to√†n b·ªô block ANTI-RAGDOLL V1 c≈©** b·∫±ng ƒëo·∫°n n√†y
-- (bao g·ªìm m·∫•y bi·∫øn: antiRagdollEnabled, ragdollConnections, cachedCharData,
--  isRagdolled, removeRagdollConstraints, forceExitRagdoll, v1HeartbeatLoop, v.v.)

local ANTI_RAGDOLL = {}

local antiRagdollMode = nil        -- "v1" = h·ªßy ragdoll + cho ch·∫°y l·∫°i, "v2" = freeze t·∫°i ch·ªó
local ragdollConnections = {}
local cachedCharData = {}

-- Cache character data for performance
local function cacheCharacterData()
    local char = player.Character
    if not char then return false end
    
    local hum = char:FindFirstChildOfClass("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    if not hum or not root then return false end
    
    cachedCharData = {
        character = char,
        humanoid = hum,
        root = root,
        originalWalkSpeed = hum.WalkSpeed,
        originalJumpPower = hum.JumpPower,
        isFrozen = false
    }
    
    return true
end

-- Clean disconnect helper
local function disconnectAll()
    for _, conn in ipairs(ragdollConnections) do
        if typeof(conn) == "RBXScriptConnection" then
            pcall(function() conn:Disconnect() end)
        end
    end
    ragdollConnections = {}
end

-- Check if currently ragdolled (using multiple detection methods)
local function isRagdolled()
    if not cachedCharData.humanoid then return false end
    
    local hum = cachedCharData.humanoid
    local state = hum:GetState()
    
    -- State check
    local ragdollStates = {
        [Enum.HumanoidStateType.Physics]     = true,
        [Enum.HumanoidStateType.Ragdoll]     = true,
        [Enum.HumanoidStateType.FallingDown] = true
    }
    
    if ragdollStates[state] then
        return true
    end
    
    -- Timer attribute check (game set attr n√†y khi ragdoll)
    local endTime = player:GetAttribute("RagdollEndTime")
    if endTime then
        local now = Workspace:GetServerTimeNow()
        if (endTime - now) > 0 then
            return true
        end
    end
    
    return false
end

-- Remove all ragdoll constraints (v1 method)
local function removeRagdollConstraints()
    if not cachedCharData.character then return end
    
    local removed = false
    
    for _, descendant in ipairs(cachedCharData.character:GetDescendants()) do
        if descendant:IsA("BallSocketConstraint")
        or (descendant:IsA("Attachment") and descendant.Name:find("RagdollAttachment")) then
            pcall(function()
                descendant:Destroy()
                removed = true
            end)
        end
    end
    
    return removed
end

-- Force exit ragdoll state
local function forceExitRagdoll()
    if not cachedCharData.humanoid or not cachedCharData.root then return end
    
    local hum = cachedCharData.humanoid
    local root = cachedCharData.root
    
    -- Clear ragdoll timer
    pcall(function()
        local now = Workspace:GetServerTimeNow()
        player:SetAttribute("RagdollEndTime", now)
    end)
    
    -- Force standing state
    if hum.Health > 0 then
        hum:ChangeState(Enum.HumanoidStateType.Running)
    end
    
    -- Reset physics (ch·∫∑n b·ªã ƒë√°nh bay)
    root.Anchored = false
    root.AssemblyLinearVelocity = Vector3.zero
    root.AssemblyAngularVelocity = Vector3.zero
end

-- Freeze player in place (v2 method ‚Äì n·∫øu sau n√†y c·∫ßn d√πng)
local function freezePlayer()
    if not cachedCharData.humanoid or not cachedCharData.root then return end
    if cachedCharData.isFrozen then return end
    
    local hum = cachedCharData.humanoid
    local root = cachedCharData.root
    
    -- Save current stats
    cachedCharData.originalWalkSpeed = hum.WalkSpeed
    cachedCharData.originalJumpPower = hum.JumpPower
    
    -- Freeze
    hum.WalkSpeed = 0
    hum.JumpPower = 0
    root.Anchored = true
    root.AssemblyLinearVelocity = Vector3.zero
    root.AssemblyAngularVelocity = Vector3.zero
    
    cachedCharData.isFrozen = true
end

-- Unfreeze player (v2 method)
local function unfreezePlayer()
    if not cachedCharData.humanoid or not cachedCharData.root then return end
    if not cachedCharData.isFrozen then return end
    
    local hum = cachedCharData.humanoid
    local root = cachedCharData.root
    
    -- Restore stats
    hum.WalkSpeed = cachedCharData.originalWalkSpeed or 16
    hum.JumpPower = cachedCharData.originalJumpPower or 50
    
    -- Unfreeze
    root.Anchored = false
    root.AssemblyLinearVelocity = Vector3.zero
    root.AssemblyAngularVelocity = Vector3.zero
    
    cachedCharData.isFrozen = false
end

-- Main heartbeat loop for v1 (Moveable ‚Äì gi·ªëng b·∫£n 6000 d√≤ng khi b·∫≠t ‚ÄúAnti-Ragdoll v2 (Moveable)‚Äù)
local function v1HeartbeatLoop()
    while antiRagdollMode == "v1" and cachedCharData.humanoid do
        task.wait()
        
        if isRagdolled() then
            -- Remove constraints and force exit
            removeRagdollConstraints()
            forceExitRagdoll()
        end
    end
end

-- Main heartbeat loop for v2 (Freeze ‚Äì gi·ªØ l·∫°i n·∫øu mai m·ªët mu·ªën d√πng)
local function v2HeartbeatLoop()
    while antiRagdollMode == "v2" and cachedCharData.humanoid do
        task.wait()
        
        if isRagdolled() then
            freezePlayer()
        else
            unfreezePlayer()
        end
    end
end

-- Setup camera binding cho mode v1
local function setupCameraBinding()
    if not cachedCharData.humanoid then return end
    
    local conn = RunService.RenderStepped:Connect(function()
        if antiRagdollMode ~= "v1" then return end
        
        local cam = Workspace.CurrentCamera
        if cam and cachedCharData.humanoid and cam.CameraSubject ~= cachedCharData.humanoid then
            cam.CameraSubject = cachedCharData.humanoid
        end
    end)
    
    table.insert(ragdollConnections, conn)
end

-- Handle character respawn
local function onCharacterAdded(char)
    task.wait(0.5) -- Wait for character to load
    
    if not antiRagdollMode then return end
    
    if cacheCharacterData() then
        if antiRagdollMode == "v1" then
            setupCameraBinding()
            task.spawn(v1HeartbeatLoop)
        elseif antiRagdollMode == "v2" then
            task.spawn(v2HeartbeatLoop)
        end
    end
end

function ANTI_RAGDOLL.Enable(mode)
    -- mode: "v1" = h·ªßy ragdoll + cho ch·∫°y, "v2" = freeze
    if mode ~= "v1" and mode ~= "v2" then 
        warn("[Anti-Ragdoll] Invalid mode:", mode)
        return 
    end
    
    if antiRagdollMode == mode then return end
    
    -- T·∫Øt mode c≈© n·∫øu ƒëang b·∫≠t
    ANTI_RAGDOLL.Disable()
    
    -- Cache nh√¢n v·∫≠t
    if not cacheCharacterData() then
        warn("[Anti-Ragdoll] Failed to cache character data")
        return
    end
    
    antiRagdollMode = mode
    
    -- Listen respawn
    local charConn = player.CharacterAdded:Connect(onCharacterAdded)
    table.insert(ragdollConnections, charConn)
    
    -- Start mode t∆∞∆°ng ·ª©ng
    if mode == "v1" then
        setupCameraBinding()
        task.spawn(v1HeartbeatLoop)
        showNotification("Anti-Ragdoll v2 (Moveable) Enabled", COLORS.Green)
    else
        task.spawn(v2HeartbeatLoop)
        showNotification("Anti-Ragdoll v1 (Freeze) Enabled", COLORS.Green)
    end
end

function ANTI_RAGDOLL.Disable()
    if not antiRagdollMode then return end
    
    antiRagdollMode = nil
    
    -- Unfreeze n·∫øu ƒëang freeze
    if cachedCharData.isFrozen then
        unfreezePlayer()
    end
    
    -- Disconnect all
    disconnectAll()
    
    -- Clear cache
    cachedCharData = {}
    
    showNotification("‚úó Anti-Ragdoll Disabled", COLORS.Red)
end
local function toggleRagdoll()
    antiRagdollEnabled = not antiRagdollEnabled
    CONFIG.ANTI_RAGDOLL_V2_ENABLED = antiRagdollEnabled
    saveConfig()

    if antiRagdollEnabled then
        btnRagdoll.Text = "Ragdoll: ON"
        btnRagdoll.BackgroundColor3 = Color3.fromRGB(100, 220, 100)
        ANTI_RAGDOLL.Enable("v1")   -- b·∫£n moveable
    else
        btnRagdoll.Text = "Ragdoll: OFF"
        btnRagdoll.BackgroundColor3 = Color3.fromRGB(255, 100, 150)
        ANTI_RAGDOLL.Disable()
    end
end



---------------------------------------------------------
-- üîÅ INIT L√öC V√ÄO GAME (TH√äM V√ÄO CU·ªêI SCRIPT INIT)
---------------------------------------------------------
-- ·ªû ƒëo·∫°n cu·ªëi script (ph·∫ßn INIT), sau:
--   if antiRagdollEnabled then ... (x√≥a m·∫•y d√≤ng c≈© ƒë√≥ ƒëi)
-- thay b·∫±ng:

if CONFIG.ANTI_RAGDOLL_V2_ENABLED then
    ANTI_RAGDOLL.Enable("v1")
end

---------------------------------------------------------
-- üîÅ CHARACTER RESPAWN (S·ª¨A ƒêO·∫†N C≈®)
---------------------------------------------------------
-- Trong player.CharacterAdded:Connect(function(char) ... cu·ªëi script,
-- X√ìA ph·∫ßn:
--[[
    if antiRagdollEnabled then
        cacheCharacterData()
        startAntiRagdoll()
    end
]]

-- v√¨ h·ªá th·ªëng m·ªõi ƒë√£ t·ª± hook trong ANTI_RAGDOLL.Enable() ·ªü tr√™n.

---------------------------------------------------------
-- ‚ö° STEAL SPEED
---------------------------------------------------------
local stealSpeedConn = nil
local STEAL_SPEED_ENABLED = CONFIG.STEAL_SPEED_ENABLED
local STEAL_SPEED = CONFIG.STEAL_SPEED_VALUE

local function startStealSpeed()
    if stealSpeedConn then return end

    stealSpeedConn = RunService.Heartbeat:Connect(function()
        if not STEAL_SPEED_ENABLED then return end
        if not player:GetAttribute('Stealing') then return end

        local char = player.Character
        if not char then return end
        local hum = char:FindChildOfClass('Humanoid')
        local hrp = char:FindFirstChild('HumanoidRootPart')
        if not hum or not hrp then return end

        local move = hum.MoveDirection
        if move.Magnitude > 0 then
            hrp.AssemblyLinearVelocity = Vector3.new(
                move.X * STEAL_SPEED,
                hrp.AssemblyLinearVelocity.Y,
                move.Z * STEAL_SPEED
            )
        end
    end)
end

local function stopStealSpeed()
    if stealSpeedConn then
        stealSpeedConn:Disconnect()
        stealSpeedConn = nil
    end
end

player:GetAttributeChangedSignal('Stealing'):Connect(function()
    if player:GetAttribute('Stealing') then
        if STEAL_SPEED_ENABLED then startStealSpeed() end
    else
        stopStealSpeed()
    end
end)

---------------------------------------------------------
-- üßπ CLEAR AVATAR ITEMS (MAP)
---------------------------------------------------------
local function clearAvatarItems()
    local count = 0
    local itemTypes = {
        'Accessory', 'Hat', 'Shirt', 'Pants', 'ShirtGraphic',
        'BodyColors', 'CharacterMesh', 'Clothing'
    }
    
    for _, obj in ipairs(Workspace:GetDescendants()) do
        for _, itemType in ipairs(itemTypes) do
            if obj:IsA(itemType) then
                pcall(function()
                    obj:Destroy()
                    count = count + 1
                end)
                break
            end
        end
    end
    
    return count
end

---------------------------------------------------------
-- üëã SPAM SLAP
---------------------------------------------------------
local spamSlapLoop = nil
local isSpamming = CONFIG.SPAM_SLAP_ENABLED

local function getSlapTool()
    local backpack = player:WaitForChild('Backpack')
    for _, item in ipairs(backpack:GetChildren()) do
        if item:IsA('Tool') and string.find(string.lower(item.Name), 'slap') then
            return item
        end
    end
    local char = player.Character
    if char then
        for _, item in ipairs(char:GetChildren()) do
            if item:IsA('Tool') and string.find(string.lower(item.Name), 'slap') then
                return item
            end
        end
    end
end

local function startSpamSlap()
    if spamSlapLoop then return end
    
    spamSlapLoop = task.spawn(function()
        while isSpamming do
            local char = player.Character
            if char then
                local hum = char:FindFirstChild('Humanoid')
                local tool = getSlapTool()
                if hum and tool then
                    if tool.Parent == player.Backpack then 
                        hum:EquipTool(tool) 
                    end
                    task.wait(0.1)
                else 
                    task.wait(0.5) 
                end
            else 
                task.wait(0.5) 
            end
        end
        spamSlapLoop = nil
    end)
end

local function stopSpamSlap()
    isSpamming = false
    if spamSlapLoop then
        task.cancel(spamSlapLoop)
        spamSlapLoop = nil
    end
end

---------------------------------------------------------
-- üëÅÔ∏è X-RAY PLOTS
---------------------------------------------------------
local ModifiedParts, OriginalProperties = {}, {}
local XrayTransparency = 0.7
local xrayEnabled = CONFIG.XRAY_ENABLED

local PlotsFolder = Workspace:FindFirstChild('Plots')
local possible = {'Plot','plots','Buildings','Houses','Bases'}
if not PlotsFolder then
    for _, n in ipairs(possible) do
        PlotsFolder = Workspace:FindFirstChild(n)
        if PlotsFolder then break end
    end
end

local function isInPlots(part)
    if not PlotsFolder then return false end
    local c = part
    while c and c ~= Workspace do
        if c == PlotsFolder then return true end
        c = c.Parent
    end
end

local function isInsideClaim(part)
    local c = part
    while c and c ~= Workspace do
        if string.find(string.lower(c.Name), 'claim') then return true end
        c = c.Parent
    end
end

local function isWall(part)
    if not part:IsA('BasePart') then return false end
    if part.Parent and (part.Parent:FindFirstChild('Humanoid') or (part.Parent.Parent and part.Parent.Parent:FindFirstChild('Humanoid'))) then
        return false
    end
    if isInsideClaim(part) then return false end
    return isInPlots(part)
end

local function applyXray(part)
    if isWall(part) then
        if not OriginalProperties[part] then
            OriginalProperties[part] = {Transparency = part.Transparency}
        end
        part.Transparency = XrayTransparency
        ModifiedParts[part] = true
    end
end

local function restorePlots()
    for part, _ in pairs(ModifiedParts) do
        if part and part.Parent and OriginalProperties[part] then
            part.Transparency = OriginalProperties[part].Transparency
        end
    end
    table.clear(ModifiedParts)
end

if PlotsFolder then
    PlotsFolder.DescendantAdded:Connect(function(obj)
        if xrayEnabled and obj:IsA('BasePart') then
            task.wait(0.1)
            applyXray(obj)
        end
    end)
end

---------------------------------------------------------
-- üöÄ LIFT PLATFORM
---------------------------------------------------------
local Settings = {
    PlatformSize = Vector3.new(6, 1, 6),
    LIFT_SPEED = CONFIG.LIFT_SPEED,
    PlatformColor = Color3.fromRGB(100, 100, 255),
    Transparency = 0.3,
    CheckDistance = 8
}
local platform, liftConnection
local isBlocked = false
local liftEnabled = CONFIG.LIFT_ENABLED

local function checkCeiling()
    local char = player.Character
    if not char then return false end
    local hrp = char:FindFirstChild('HumanoidRootPart')
    if not hrp then return false end

    local rayOrigin = hrp.Position + Vector3.new(0, 2, 0)
    local rayDirection = Vector3.new(0, Settings.CheckDistance, 0)

    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {char, platform}
    params.FilterType = Enum.RaycastFilterType.Exclude

    local result = workspace:Raycast(rayOrigin, rayDirection, params)
    if result then
        local dist = (result.Position - rayOrigin).Magnitude
        if dist < 3 then return true end
    end
    return false
end

local function createPlatform()
    if platform then platform:Destroy() end
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild('HumanoidRootPart')
    if not hrp then return end

    platform = Instance.new('Part')
    platform.Size = Settings.PlatformSize
    platform.Anchored = true
    platform.CanCollide = true
    platform.Material = Enum.Material.Neon
    platform.Color = Settings.PlatformColor
    platform.Transparency = Settings.Transparency
    platform.Name = 'LiftPlatform'
    platform.Parent = workspace

    local posBelow = hrp.Position - Vector3.new(0, 3.5, 0)
    platform.CFrame = CFrame.new(posBelow)

    local light = Instance.new('PointLight', platform)
    light.Brightness = 2
    light.Range = 15
    light.Color = Settings.PlatformColor

    isBlocked = false
    return platform
end

local function stopLifting()
    if liftConnection then 
        liftConnection:Disconnect() 
        liftConnection = nil 
    end
    if platform then 
        platform:Destroy() 
        platform = nil 
    end
    isBlocked = false
end

local function startLifting()
    if not platform then createPlatform() end
    if not platform then return end
    if liftConnection then liftConnection:Disconnect() end
    
    liftConnection = RunService.Heartbeat:Connect(function(dt)
        if not platform or not platform.Parent then 
            stopLifting()
            return 
        end
        local char = player.Character
        if not char then return end
        local hrp = char:FindFirstChild('HumanoidRootPart')
        if not hrp then return end

        if checkCeiling() then
            if not isBlocked then
                isBlocked = true
                platform.Color = Color3.fromRGB(255, 100, 100)
            end
            local x, z = hrp.Position.X, hrp.Position.Z
            local y = platform.Position.Y
            platform.CFrame = CFrame.new(x, y, z)
            return
        else
            if isBlocked then
                isBlocked = false
                platform.Color = Settings.PlatformColor
            end
        end

        local current = platform.Position
        local newY = current.Y + Settings.LIFT_SPEED * dt
        local x, z = hrp.Position.X, hrp.Position.Z
        platform.CFrame = CFrame.new(x, newY, z)
    end)
end

---------------------------------------------------------
-- üñ•Ô∏è MOBILE DRAG HELPER FUNCTION
---------------------------------------------------------
local function makeDraggable(frame, dragHandle)
    local dragging = false
    local dragInput, dragStart, startPos
    
    local function updateDrag(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
    
    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    dragHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            updateDrag(input)
        end
    end)
end

---------------------------------------------------------
-- üñ•Ô∏è GUI SYSTEM - 3 TABS (TAB 1: Clear Avatar, ESP, X-Ray, Anti-Bee, Ragdoll)
--                         (TAB 2: Auto-Steal, Steal Speed, TP Highest, Safe TP, Player ESP)
--                         (TAB 3: Spam Slap, Lift, Desync, Cloner, Kick)
---------------------------------------------------------

-- üîπ N√öT CONTROL G√ìC TR√ÅI TR√äN
local controlButton = Instance.new('TextButton', screenGui)
controlButton.Name = 'ControlButton'
controlButton.Size = UDim2.new(0, 55, 0, 55)
controlButton.Position = UDim2.new(0, 10, 0, 80)
controlButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
controlButton.TextColor3 = Color3.new(1, 1, 1)
controlButton.Font = Enum.Font.GothamBold
controlButton.TextSize = 22
controlButton.Text = '‚ò∞'
controlButton.Visible = CONFIG.CONTROL_BTN_VISIBLE
controlButton.ZIndex = 10
Instance.new('UICorner', controlButton).CornerRadius = UDim.new(0, 12)

local controlShadow = Instance.new('UIStroke', controlButton)
controlShadow.Color = Color3.fromRGB(0, 0, 0)
controlShadow.Thickness = 2
controlShadow.Transparency = 0.5

-- üîπ MAIN FRAME - Responsive cho mobile + PC
local mainFrame = Instance.new('Frame', screenGui)
mainFrame.Name = 'MainFrame'
mainFrame.Size = UDim2.new(0, MAIN_WIDTH, 0, MAIN_HEIGHT)
mainFrame.Position = UDim2.new(0.5, -MAIN_WIDTH/2, 0.5, -MAIN_HEIGHT/2)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.BorderSizePixel = 0
mainFrame.Visible = CONFIG.MAIN_MENU_VISIBLE
mainFrame.ZIndex = 2
Instance.new('UICorner', mainFrame).CornerRadius = UDim.new(0, 12)


local mainShadow = Instance.new('UIStroke', mainFrame)
mainShadow.Color = Color3.fromRGB(0, 0, 0)
mainShadow.Thickness = 3
mainShadow.Transparency = 0.3

-- üîπ TITLE BAR
local titleBar = Instance.new('Frame', mainFrame)
titleBar.Size = UDim2.new(1, 0, 0, 35)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleBar.BorderSizePixel = 0
titleBar.ZIndex = 3
Instance.new('UICorner', titleBar).CornerRadius = UDim.new(0, 12)

local titleLabel = Instance.new('TextLabel', titleBar)
titleLabel.Size = UDim2.new(1, -70, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = 'discord.gg/NBnWHSpbjT'
titleLabel.TextColor3 = Color3.fromRGB(120, 240, 255)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 14
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.ZIndex = 4

local closeBtn = Instance.new('TextButton', titleBar)
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -33, 0.5, -15)
closeBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
closeBtn.Text = 'X'
closeBtn.TextColor3 = Color3.new(1, 1, 1)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 16
closeBtn.ZIndex = 5
Instance.new('UICorner', closeBtn).CornerRadius = UDim.new(0, 8)

-- üîπ TAB BUTTONS (2 N√öT)
local tabButtonsFrame = Instance.new('Frame', mainFrame)
tabButtonsFrame.Size = UDim2.new(1, -10, 0, 40)
tabButtonsFrame.Position = UDim2.new(0, 5, 0, 40)
tabButtonsFrame.BackgroundTransparency = 1
tabButtonsFrame.ZIndex = 3

local tabButtons = {}
local tabNames = {'Stealer', 'On/Off Features'}

local function createTabButton(index, text)
    local btn = Instance.new('TextButton', tabButtonsFrame)
    btn.Name = 'Tab' .. index
    btn.Size = UDim2.new(0.5, -5, 1, 0)
    btn.Position = UDim2.new((index - 1) * 0.5, (index - 1) * 5, 0, 0)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 13
    btn.Text = text
    btn.ZIndex = 4
    Instance.new('UICorner', btn).CornerRadius = UDim.new(0, 8)
    
    table.insert(tabButtons, btn)
    return btn
end

for i = 1, 2 do
    createTabButton(i, tabNames[i])
end

-- üîπ CONTENT FRAMES (CH·ªà 2 TAB)
local contentFrames = {}

for i = 1, 2 do
    local contentFrame = Instance.new('ScrollingFrame', mainFrame)
    contentFrame.Name = 'ContentFrame' .. i
    contentFrame.Size = UDim2.new(1, -10, 1, -90)
    contentFrame.Position = UDim2.new(0, 5, 0, 85)
    contentFrame.BackgroundTransparency = 1
    contentFrame.BorderSizePixel = 0
    contentFrame.ScrollBarThickness = 4
    contentFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    contentFrame.Visible = (i == CONFIG.CURRENT_TAB)
    contentFrame.ZIndex = 3
    
    local listLayout = Instance.new('UIListLayout', contentFrame)
    listLayout.Padding = UDim.new(0, 6)
    listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    
    listLayout:GetPropertyChangedSignal('AbsoluteContentSize'):Connect(function()
        contentFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
    end)
    
    table.insert(contentFrames, contentFrame)
end

-- üîπ BUTTON CREATOR
local buttons = {}

-- üì¶ Responsive Button Creator
local function makeButton(parent, name, text, color)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Parent = parent

    -- N√∫t full chi·ªÅu ngang, ch·ª´a l·∫°i 20px
    btn.Size = UDim2.new(1, -20, 0, BUTTON_HEIGHT)
    btn.BackgroundColor3 = color
    btn.BorderSizePixel = 0
    btn.AutoButtonColor = false

    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Font = Enum.Font.GothamBold
    btn.TextScaled = true
    btn.ZIndex = 4

    -- Bo g√≥c
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = btn

    -- Vi·ªÅn nh·∫π
    local stroke = Instance.new("UIStroke")
    stroke.Parent = btn
    stroke.Thickness = 1
    stroke.Transparency = 0.7
    stroke.Color = Color3.fromRGB(255, 255, 255)

    return btn
end


-- üîπ TAB 1 (STEALER): 7 n√∫t
local btnClearItems = makeButton(contentFrames[1], 'ClearItemsBtn', 'Clear Avatar', Color3.fromRGB(220, 50, 50))
local btnXRay       = makeButton(contentFrames[1], 'XRayBtn', 'X-Ray: ' .. (xrayEnabled and 'ON' or 'OFF'), Color3.fromRGB(150, 50, 220))
local btnSpamSlap   = makeButton(contentFrames[1], 'SpamSlapBtn', 'Spam Slap: ' .. (isSpamming and 'ON (R)' or 'OFF (R)'), Color3.fromRGB(50, 150, 220))
local btnLift       = makeButton(contentFrames[1], 'LiftBtn', 'Lift: ' .. (liftEnabled and 'ON (C)' or 'OFF (C)'), Color3.fromRGB(255, 140, 0))
local btnDesync     = makeButton(contentFrames[1], 'DesyncBtn', 'Desync V3', Color3.fromRGB(120, 240, 255))
local btnCloner     = makeButton(contentFrames[1], 'ClonerBtn', 'Cloner', Color3.fromRGB(255, 180, 50))
local btnKick       = makeButton(contentFrames[1], 'KickBtn', 'Kick Self', Color3.fromRGB(255, 60, 60))

-- üîπ TAB 2 (ON/OFF FEATURES): 8 n√∫t
local btnAutoSteal    = makeButton(contentFrames[2], 'AutoStealBtn', 'Auto-Steal: ' .. (AUTO_STEAL_ENABLED and 'ON' or 'OFF'), Color3.fromRGB(100, 200, 100))
local btnStealSpeed   = makeButton(contentFrames[2], 'StealSpeedBtn', 'Steal Speed: ' .. (STEAL_SPEED_ENABLED and 'ON' or 'OFF'), Color3.fromRGB(150, 100, 200))
local btnTpHighest    = makeButton(contentFrames[2], 'TpHighestBtn', 'TP Highest', Color3.fromRGB(0, 200, 255))
local btnSafeTp       = makeButton(contentFrames[2], 'SafeTpBtn', 'Safe TP: ' .. (CONFIG.SAFE_TELEPORT and 'ON' or 'OFF'), Color3.fromRGB(100, 255, 150))
local btnPlayerESP    = makeButton(contentFrames[2], 'PlayerESPBtn', 'Player ESP: ' .. (CONFIG.ESP_PLAYERS_ENABLED and 'ON' or 'OFF'), Color3.fromRGB(120, 240, 255))
local btnRagdoll      = makeButton(contentFrames[2], 'RagdollBtn', 'Ragdoll: ' .. (antiRagdollEnabled and 'ON' or 'OFF'), Color3.fromRGB(255, 100, 150))
local btnAntiBee      = makeButton(contentFrames[2], 'AntiBeeBtn', 'Anti-Bee: ' .. (CONFIG.ANTI_BEE_DISCO_ENABLED and 'ON' or 'OFF'), Color3.fromRGB(255, 200, 50))
local btnBrainrotESP  = makeButton(contentFrames[2], 'BrainrotESPBtn', 'Animal ESP: ' .. (CONFIG.ESP_ENABLED and 'ON' or 'OFF'), Color3.fromRGB(220, 120, 255))

-- üîπ TAB SWITCHING SYSTEM
local function switchTab(tabIndex)
    CONFIG.CURRENT_TAB = tabIndex
    saveConfig()
    
    for i, frame in ipairs(contentFrames) do
        frame.Visible = (i == tabIndex)
    end
    
    for i, btn in ipairs(tabButtons) do
        if i == tabIndex then
            btn.BackgroundColor3 = Color3.fromRGB(70, 200, 120)
        else
            btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        end
    end
end

for i, btn in ipairs(tabButtons) do
    btn.MouseButton1Click:Connect(function()
        switchTab(i)
    end)
end

switchTab(CONFIG.CURRENT_TAB)
-- üîπ APPLY DRAGGABLE TO MAIN FRAME
makeDraggable(mainFrame, titleBar)

-- üîπ CONTROL BUTTON TOGGLE
controlButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
    CONFIG.MAIN_MENU_VISIBLE = mainFrame.Visible
    saveConfig()
    
    controlButton.Text = mainFrame.Visible and '‚ò∞' or '‚öôÔ∏è'
end)

closeBtn.MouseButton1Click:Connect(function()
    mainFrame.Visible = false
    CONFIG.MAIN_MENU_VISIBLE = false
    saveConfig()
    
    controlButton.Text = '‚öôÔ∏è'
end)

---------------------------------------------------------
-- üì± MINI GUI CHO MOBILE (4 N√öT NHANH)
---------------------------------------------------------
local miniGuiFrame = Instance.new('Frame', screenGui)
miniGuiFrame.Name = 'MiniGuiFrame'
miniGuiFrame.Size = UDim2.new(0, 65, 0, 280)
miniGuiFrame.Position = UDim2.new(1, -75, 0.5, -140)
miniGuiFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
miniGuiFrame.BackgroundTransparency = 0.3
miniGuiFrame.BorderSizePixel = 0
miniGuiFrame.Visible = CONFIG.MINI_GUI_VISIBLE
miniGuiFrame.ZIndex = 5
Instance.new('UICorner', miniGuiFrame).CornerRadius = UDim.new(0, 12)

local miniListLayout = Instance.new('UIListLayout', miniGuiFrame)
miniListLayout.Padding = UDim.new(0, 8)
miniListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
miniListLayout.VerticalAlignment = Enum.VerticalAlignment.Center

local function makeMiniButton(name, emoji, color)
    local btn = Instance.new('TextButton', miniGuiFrame)
    btn.Name = name
    btn.Size = UDim2.new(0, 55, 0, 55)
    btn.BackgroundColor3 = color
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 26
    btn.Text = emoji
    btn.ZIndex = 6
    Instance.new('UICorner', btn).CornerRadius = UDim.new(0, 12)
    
    local stroke = Instance.new('UIStroke', btn)
    stroke.Color = Color3.fromRGB(255, 255, 255)
    stroke.Thickness = 2
    stroke.Transparency = 0.7
    
    return btn
end

local miniCloner = makeMiniButton('MiniCloner', 'Clon', Color3.fromRGB(255, 180, 50))
local miniSpamSlap = makeMiniButton('MiniSpamSlap', 'Lag', Color3.fromRGB(50, 150, 220))
local miniTpHighest = makeMiniButton('MiniTpHighest', 'Tp', Color3.fromRGB(0, 200, 255))
local miniLift = makeMiniButton('MiniLift', 'Lift', Color3.fromRGB(255, 140, 0))

-- Update mini button colors based on state
if isSpamming then
    miniSpamSlap.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
end
if liftEnabled then
    miniLift.BackgroundColor3 = Color3.fromRGB(100, 220, 100)
end

---------------------------------------------------------
-- üì± MINI GUI B√äN TR√ÅI (2 N√öT: DESYNC + KICK SELF)
---------------------------------------------------------
local miniLeftGuiFrame = Instance.new('Frame', screenGui)
miniLeftGuiFrame.Name = 'MiniLeftGuiFrame'
miniLeftGuiFrame.Size = UDim2.new(0, 65, 0, 140)
miniLeftGuiFrame.Position = UDim2.new(0, 10, 0.5, -70)
miniLeftGuiFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
miniLeftGuiFrame.BackgroundTransparency = 0.3
miniLeftGuiFrame.BorderSizePixel = 0
miniLeftGuiFrame.Visible = CONFIG.MINI_LEFT_GUI_VISIBLE
miniLeftGuiFrame.ZIndex = 5
Instance.new('UICorner', miniLeftGuiFrame).CornerRadius = UDim.new(0, 12)

local miniLeftListLayout = Instance.new('UIListLayout', miniLeftGuiFrame)
miniLeftListLayout.Padding = UDim.new(0, 8)
miniLeftListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
miniLeftListLayout.VerticalAlignment = Enum.VerticalAlignment.Center

local miniDesync = makeMiniButton('MiniDesync', 'Desy', Color3.fromRGB(120, 240, 255))
miniDesync.Parent = miniLeftGuiFrame

local miniKick = makeMiniButton('MiniKick', 'Kick', Color3.fromRGB(255, 60, 60))
miniKick.Parent = miniLeftGuiFrame

---------------------------------------------------------
-- üéöÔ∏èUNLOCK FLOOR + FPS/MS
---------------------------------------------------------
local modeButtons = {}
local fpsLabel, msLabel

local function updateModeButtons()
    for idx, btn in ipairs(modeButtons) do
        if idx == currentMode then
            btn.BackgroundColor3 = Color3.fromRGB(70, 200, 120)
        else
            btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        end
    end
end

local function setMode(mode)
    if mode < 1 or mode > 3 then return end
    currentMode = mode
    CONFIG.CURRENT_MODE = mode
    updateModeButtons()
    saveConfig()
    print('[Mode/Floor] Unlock floor', mode)
    smartInteract(mode)
end

local function createModeGui()
    local modeFrame = Instance.new('Frame', screenGui)
    modeFrame.Name = 'ModeSelector'
    modeFrame.Size = UDim2.new(0, 280, 0, 95)
    
    if CONFIG.MODE_GUI_POSITION_X and CONFIG.MODE_GUI_POSITION_Y then
        modeFrame.Position = UDim2.new(0, CONFIG.MODE_GUI_POSITION_X, 0, CONFIG.MODE_GUI_POSITION_Y)
    else
        modeFrame.Position = UDim2.new(0.5, -140, 0.15, 0)
    end
    
    modeFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    modeFrame.BorderSizePixel = 0
    modeFrame.ZIndex = 8
    Instance.new('UICorner', modeFrame).CornerRadius = UDim.new(0, 10)

    local label = Instance.new('TextLabel', modeFrame)
    label.Size = UDim2.new(1, 0, 0, 20)
    label.Position = UDim2.new(0, 0, 0, 2)
    label.BackgroundTransparency = 1
    label.Text = 'discord.gg/NBnWHSpbjT'
    label.Font = Enum.Font.GothamBold
    label.TextSize = 13
    label.TextColor3 = Color3.new(1, 1, 1)
    label.ZIndex = 9

    local holder = Instance.new('Frame', modeFrame)
    holder.Size = UDim2.new(1, -16, 0, 32)
    holder.Position = UDim2.new(0, 8, 0, 24)
    holder.BackgroundTransparency = 1
    holder.ZIndex = 9

    local layout = Instance.new('UIListLayout', holder)
    layout.FillDirection = Enum.FillDirection.Horizontal
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.VerticalAlignment = Enum.VerticalAlignment.Center
    layout.Padding = UDim.new(0, 6)

    for i = 1, 3 do
        local btn = Instance.new('TextButton', holder)
        btn.Name = 'Mode' .. i
        btn.Size = UDim2.new(0, 75, 0, 32)
        btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 14
        btn.Text = 'Floor ' .. tostring(i)
        btn.ZIndex = 10
        Instance.new('UICorner', btn).CornerRadius = UDim.new(0, 8)

        btn.MouseButton1Click:Connect(function()
            setMode(i)
        end)

        table.insert(modeButtons, btn)
    end

    updateModeButtons()
    
    local statsFrame = Instance.new('Frame', modeFrame)
    statsFrame.Size = UDim2.new(1, -16, 0, 28)
    statsFrame.Position = UDim2.new(0, 8, 0, 60)
    statsFrame.BackgroundTransparency = 1
    statsFrame.ZIndex = 9
    
    fpsLabel = Instance.new('TextLabel', statsFrame)
    fpsLabel.Size = UDim2.new(0.5, -4, 1, 0)
    fpsLabel.Position = UDim2.new(0, 0, 0, 0)
    fpsLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    fpsLabel.BackgroundTransparency = 0.3
    fpsLabel.Text = 'FPS: --'
    fpsLabel.TextColor3 = Color3.fromRGB(120, 240, 255)
    fpsLabel.Font = Enum.Font.GothamBold
    fpsLabel.TextSize = 12
    fpsLabel.ZIndex = 10
    Instance.new('UICorner', fpsLabel).CornerRadius = UDim.new(0, 6)
    
    msLabel = Instance.new('TextLabel', statsFrame)
    msLabel.Size = UDim2.new(0.5, -4, 1, 0)
    msLabel.Position = UDim2.new(0.5, 4, 0, 0)
    msLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    msLabel.BackgroundTransparency = 0.3
    msLabel.Text = 'MS: --'
    msLabel.TextColor3 = Color3.fromRGB(255, 140, 255)
    msLabel.Font = Enum.Font.GothamBold
    msLabel.TextSize = 12
    msLabel.ZIndex = 10
    Instance.new('UICorner', msLabel).CornerRadius = UDim.new(0, 6)
    
    local lastUpdate = tick()
    local frameCount = 0
    
    RunService.Heartbeat:Connect(function()
        frameCount = frameCount + 1
        local now = tick()
        
        if now - lastUpdate >= 1 then
            local fps = frameCount
            local ping = Stats.Network.ServerStatsItem['Data Ping']:GetValue()
            
            fpsLabel.Text = string.format('FPS: %d', fps)
            msLabel.Text = string.format('MS: %d', math.floor(ping))
            
            if fps >= 50 then
                fpsLabel.TextColor3 = Color3.fromRGB(120, 255, 120)
            elseif fps >= 30 then
                fpsLabel.TextColor3 = Color3.fromRGB(255, 255, 120)
            else
                fpsLabel.TextColor3 = Color3.fromRGB(255, 120, 120)
            end
            
            if ping <= 100 then
                msLabel.TextColor3 = Color3.fromRGB(120, 255, 120)
            elseif ping <= 200 then
                msLabel.TextColor3 = Color3.fromRGB(255, 255, 120)
            else
                msLabel.TextColor3 = Color3.fromRGB(255, 120, 120)
            end
            
            frameCount = 0
            lastUpdate = now
        end
    end)
    
    -- APPLY DRAGGABLE TO MODE GUI
    makeDraggable(modeFrame, label)
end

createModeGui()

---------------------------------------------------------
-- üÜï TOGGLE FUNCTIONS
---------------------------------------------------------
local function toggleBrainrotESP()
    CONFIG.ESP_ENABLED = not CONFIG.ESP_ENABLED
    saveConfig()
    
    if CONFIG.ESP_ENABLED then
        btnBrainrotESP.Text = 'Animal ESP: ON'
        btnBrainrotESP.BackgroundColor3 = Color3.fromRGB(150, 50, 220)
        allAnimalsCache = getAllAnimals()
        refreshAllESP()
        print('‚úÖ Animal ESP: ON')
    else
        btnBrainrotESP.Text = 'Animal ESP: OFF'
        btnBrainrotESP.BackgroundColor3 = Color3.fromRGB(220, 120, 255)
        clearAllESP()
        print('‚ùå Animal ESP: OFF')
    end
end

local function togglePlayerESP()
    CONFIG.ESP_PLAYERS_ENABLED = not CONFIG.ESP_PLAYERS_ENABLED
    saveConfig()
    
    if CONFIG.ESP_PLAYERS_ENABLED then
        btnPlayerESP.Text = 'Player ESP: ON'
        btnPlayerESP.BackgroundColor3 = Color3.fromRGB(50, 150, 220)
        refreshPlayerESP()
    else
        btnPlayerESP.Text = 'Player ESP: OFF'
        btnPlayerESP.BackgroundColor3 = Color3.fromRGB(120, 240, 255)
        clearAllPlayerESP()
    end
end

local function toggleAntiBee()
    CONFIG.ANTI_BEE_DISCO_ENABLED = not CONFIG.ANTI_BEE_DISCO_ENABLED
    saveConfig()
    
    if CONFIG.ANTI_BEE_DISCO_ENABLED then
        startAntiBee()
        btnAntiBee.Text = 'Anti-Bee: ON'
        btnAntiBee.BackgroundColor3 = Color3.fromRGB(100, 220, 50)
    else
        stopAntiBee()
        btnAntiBee.Text = 'Anti-Bee: OFF'
        btnAntiBee.BackgroundColor3 = Color3.fromRGB(255, 200, 50)
    end
end

local function toggleSafeTp()
    CONFIG.SAFE_TELEPORT = not CONFIG.SAFE_TELEPORT
    saveConfig()
    
    if CONFIG.SAFE_TELEPORT then
        btnSafeTp.Text = 'Safe TP: ON'
        btnSafeTp.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
    else
        btnSafeTp.Text = 'Safe TP: OFF'
        btnSafeTp.BackgroundColor3 = Color3.fromRGB(100, 255, 150)
    end
end

local function toggleAutoSteal()
    AUTO_STEAL_ENABLED = not AUTO_STEAL_ENABLED
    CONFIG.AUTO_STEAL_ENABLED = AUTO_STEAL_ENABLED
    saveConfig()
    
    if AUTO_STEAL_ENABLED then
        btnAutoSteal.Text = 'Auto-Steal: ON'
        btnAutoSteal.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
        autoStealLoop()
        print('üü¢ Auto-Steal: ON')
    else
        btnAutoSteal.Text = 'Auto-Steal: OFF'
        btnAutoSteal.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
        if stealConnection then
            stealConnection:Disconnect()
            stealConnection = nil
        end
        print('üî¥ Auto-Steal: OFF')
    end
end

local function toggleStealSpeed()
    STEAL_SPEED_ENABLED = not STEAL_SPEED_ENABLED
    CONFIG.STEAL_SPEED_ENABLED = STEAL_SPEED_ENABLED
    saveConfig()
    
    if STEAL_SPEED_ENABLED then
        btnStealSpeed.Text = 'Steal Speed: ON'
        btnStealSpeed.BackgroundColor3 = Color3.fromRGB(100, 50, 220)
        startStealSpeed()
        print('üü¢ Steal Speed: ON')
    else
        btnStealSpeed.Text = 'Steal Speed: OFF'
        btnStealSpeed.BackgroundColor3 = Color3.fromRGB(150, 100, 200)
        stopStealSpeed()
        print('üî¥ Steal Speed: OFF')
    end
end

local function toggleXray()
    xrayEnabled = not xrayEnabled
    CONFIG.XRAY_ENABLED = xrayEnabled
    saveConfig()
    
    if xrayEnabled then
        btnXRay.Text = 'X-Ray: ON'
        btnXRay.BackgroundColor3 = Color3.fromRGB(100, 220, 100)
        if PlotsFolder then
            for _, obj in pairs(PlotsFolder:GetDescendants()) do
                if obj:IsA('BasePart') then applyXray(obj) end
            end
        end
    else
        btnXRay.Text = 'X-Ray: OFF'
        btnXRay.BackgroundColor3 = Color3.fromRGB(150, 50, 220)
        restorePlots()
    end
end

local function toggleLift()
    liftEnabled = not liftEnabled
    CONFIG.LIFT_ENABLED = liftEnabled
    saveConfig()
    
    if liftEnabled then
        btnLift.Text = 'Lift: ON (C)'
        btnLift.BackgroundColor3 = Color3.fromRGB(100, 220, 100)
        miniLift.BackgroundColor3 = Color3.fromRGB(100, 220, 100)
        createPlatform()
        startLifting()
    else
        btnLift.Text = 'Lift: OFF (C)'
        btnLift.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
        miniLift.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
        stopLifting()
    end
end



local function toggleSpamSlap()
    isSpamming = not isSpamming
    CONFIG.SPAM_SLAP_ENABLED = isSpamming
    saveConfig()
    
    if isSpamming then
        btnSpamSlap.Text = 'Spam Slap: ON (R)'
        btnSpamSlap.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
        miniSpamSlap.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
        startSpamSlap()
    else
        btnSpamSlap.Text = 'Spam Slap: OFF (R)'
        btnSpamSlap.BackgroundColor3 = Color3.fromRGB(50, 150, 220)
        miniSpamSlap.BackgroundColor3 = Color3.fromRGB(50, 150, 220)
        stopSpamSlap()
    end
end

---------------------------------------------------------
-- üîò BUTTON CLICKS - MAIN MENU
---------------------------------------------------------
btnClearItems.MouseButton1Click:Connect(function()
    local count = clearAvatarItems()
    btnClearItems.BackgroundColor3 = Color3.fromRGB(100, 220, 100)
    btnClearItems.Text = 'X√≥a ' .. count .. ' items!'
    task.wait(1.5)
    btnClearItems.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
    btnClearItems.Text = 'Clear Avatar'
end)

btnSpamSlap.MouseButton1Click:Connect(toggleSpamSlap)
btnXRay.MouseButton1Click:Connect(toggleXray)
btnLift.MouseButton1Click:Connect(toggleLift)
btnAutoSteal.MouseButton1Click:Connect(toggleAutoSteal)
btnStealSpeed.MouseButton1Click:Connect(toggleStealSpeed)
btnDesync.MouseButton1Click:Connect(enableDesync)
btnTpHighest.MouseButton1Click:Connect(teleportToHighest)
btnRagdoll.MouseButton1Click:Connect(toggleRagdoll)
btnCloner.MouseButton1Click:Connect(instantCloner)
btnKick.MouseButton1Click:Connect(kickSelf)
btnBrainrotESP.MouseButton1Click:Connect(toggleBrainrotESP)
btnPlayerESP.MouseButton1Click:Connect(togglePlayerESP)
btnAntiBee.MouseButton1Click:Connect(toggleAntiBee)
btnSafeTp.MouseButton1Click:Connect(toggleSafeTp)

---------------------------------------------------------
-- üîò BUTTON CLICKS - MINI GUI
---------------------------------------------------------
miniCloner.MouseButton1Click:Connect(instantCloner)
miniSpamSlap.MouseButton1Click:Connect(toggleSpamSlap)
miniTpHighest.MouseButton1Click:Connect(teleportToHighest)
miniLift.MouseButton1Click:Connect(toggleLift)
miniDesync.MouseButton1Click:Connect(enableDesync)
miniKick.MouseButton1Click:Connect(kickSelf)

---------------------------------------------------------
-- ‚å®Ô∏è HOTKEYS
---------------------------------------------------------
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    
    if input.KeyCode == Enum.KeyCode.R then
        toggleSpamSlap()
    elseif input.KeyCode == Enum.KeyCode.C then
        toggleLift()
    elseif input.KeyCode == Enum.KeyCode.V then
        instantCloner()
    elseif input.KeyCode == Enum.KeyCode.LeftControl or input.KeyCode == Enum.KeyCode.RightControl then
        -- CTRL ƒë·ªÉ ·∫©n/hi·ªán menu
        mainFrame.Visible = not mainFrame.Visible
        CONFIG.MAIN_MENU_VISIBLE = mainFrame.Visible
        saveConfig()
        controlButton.Text = mainFrame.Visible and '‚ò∞' or '‚öôÔ∏è'
    end
end)

---------------------------------------------------------
-- üîÑ CHARACTER RESPAWN HANDLER
---------------------------------------------------------
player.CharacterAdded:Connect(function(char)
    stopLifting()
    stopSpamSlap()
    
    char:WaitForChild('HumanoidRootPart')
    task.wait(0.3)
    
    if liftEnabled then
        createPlatform()
        startLifting()
    end
    
    if isSpamming then
        startSpamSlap()
    end
    
    if STEAL_SPEED_ENABLED then
        startStealSpeed()
    end
    
    if antiRagdollEnabled then
        ANTI_RAGDOLL.Enable("v1")
        print('‚úÖ Anti-Ragdoll v2 (Moveable): Enabled')
    end
end)



---------------------------------------------------------
-- üîÑ ANTI-AFK
---------------------------------------------------------
player.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    VirtualUser:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
end)

---------------------------------------------------------
-- üöÄ INITIALIZATION
---------------------------------------------------------
print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')
print('üéÆ PET FINDER MINI - VERSION 2.6 (TABS REORGANIZED)')
print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê')

if AUTO_STEAL_ENABLED then
    autoStealLoop()
    print('‚úÖ Auto-Steal: Enabled (Brainrot Logic)')
end

if STEAL_SPEED_ENABLED then
    startStealSpeed()
    print('‚úÖ Steal Speed: Enabled')
end

if isSpamming then
    startSpamSlap()
    miniSpamSlap.BackgroundColor3 = Color3.fromRGB(50, 220, 100)
    print('‚úÖ Spam Slap: Enabled')
end

if xrayEnabled and PlotsFolder then
    for _, obj in pairs(PlotsFolder:GetDescendants()) do
        if obj:IsA('BasePart') then
            applyXray(obj)
        end
    end
    print('‚úÖ X-Ray: Enabled')
end

if liftEnabled then
    createPlatform()
    startLifting()
    miniLift.BackgroundColor3 = Color3.fromRGB(100, 220, 100)
    print('‚úÖ Lift Platform: Enabled')
end

if antiRagdollEnabled then
    ANTI_RAGDOLL.Enable("v1")
    print('‚úÖ Anti-Ragdoll v2 (Moveable): Enabled')
end


if CONFIG.ANTI_BEE_DISCO_ENABLED then
    startAntiBee()
    btnAntiBee.Text = 'Anti-Bee: ON'
    btnAntiBee.BackgroundColor3 = Color3.fromRGB(100, 220, 50)
    print('‚úÖ Anti-Bee & Disco: Enabled')
end

if CONFIG.AUTO_DESYNC_ENABLED then
    task.wait(2)
    enableDesync()
end

if CONFIG.ESP_ENABLED then
    allAnimalsCache = getAllAnimals()
    refreshAllESP()
    print('‚úÖ Animal ESP: Enabled (Brainrot Logic)')
end

if CONFIG.ESP_PLAYERS_ENABLED then
    refreshPlayerESP()
    print('‚úÖ Player ESP: Enabled')
end
